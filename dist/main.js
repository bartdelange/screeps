"use strict";function n(n){switch(n.structureType){case STRUCTURE_CONTAINER:return 1e3;case STRUCTURE_SPAWN:return 900;case STRUCTURE_EXTENSION:return 750;case STRUCTURE_TOWER:return 700;case STRUCTURE_STORAGE:return 650;case STRUCTURE_ROAD:return 150;case STRUCTURE_RAMPART:return 80;case STRUCTURE_WALL:return 50;default:return 250}}function e(e,r,o){const t=e.pos.getRangeTo(r.pos);let i=n(r);r.structureType===STRUCTURE_CONTAINER&&function(n,e){for(const r of e.find(FIND_SOURCES))if(n.pos.inRangeTo(r.pos,2))return!0;return!1}(r,e.room)&&(i+=600);const u=r.progressTotal-r.progress;u<=200?i+=250:u<=500&&(i+=100);const c=function(n,e){let r=0;for(const o of Object.values(Game.creeps))o.room.name===n.name&&"builder"===o.memory.role&&o.memory.working&&o.memory.buildTargetId===e&&r++;return r}(e.room,r.id);return c>0&&t<=o.preferJoinWithin&&(i+=250,i+=75*Math.min(c,2)),c>=o.desiredMaxJoiners&&(i-=400*(c-(o.desiredMaxJoiners-1))),i-=10*t,i}function r(n,e={}){var r,o,t,i;const u=null!==(r=e.containerBelow)&&void 0!==r?r:.9,c=null!==(o=e.roadBelow)&&void 0!==o?o:.4,R=null!==(t=e.minMissingHits)&&void 0!==t?t:5e3,l=null!==(i=e.minTargets)&&void 0!==i?i:1;let s=0,a=0;const f=(n,e)=>{n.hits<=0||n.hits/n.hitsMax>=e||(a++,s+=n.hitsMax-n.hits)};for(const e of n.find(FIND_STRUCTURES))if(e.structureType===STRUCTURE_CONTAINER?f(e,u):e.structureType===STRUCTURE_ROAD&&f(e,c),a>=l&&s>=R)return!0;return a>=l&&s>=R}const o=["harvester","miner","mover","builder","upgrader"],t={harvester:{minEnergy:200,makeBody:()=>[WORK,CARRY,MOVE],memory:n=>({role:n,working:!1,retire:!1}),spawn:{desired:n=>{const e=Object.values(Game.creeps).filter(e=>e.room.name===n.name&&"miner"===e.memory.role&&!e.memory.retire).length;return n.find(FIND_SOURCES).every(n=>n.pos.findInRange(FIND_STRUCTURES,1,{filter:n=>n.structureType===STRUCTURE_CONTAINER}).length>0)&&0!==e?0:2}}},upgrader:{minEnergy:200,makeBody:({available:n,capacity:e})=>{const r=Math.min(n,e);return r>=800?[WORK,WORK,WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE,MOVE]:r>=550?[WORK,WORK,WORK,WORK,CARRY,MOVE,MOVE]:r>=400?[WORK,WORK,CARRY,MOVE]:[WORK,CARRY,MOVE]},memory:n=>({role:n,working:!1,retire:!1}),spawn:{desired:n=>{const e=n.controller;if(!e)return 0;if(e.level>=6)return 2;const o=n.find(FIND_CONSTRUCTION_SITES).length>0||r(n,{containerBelow:.9,roadBelow:.4,minMissingHits:5e3,minTargets:1}),t=n.energyCapacityAvailable;return o?t>=800?3:t>=550?2:1:t>=800?6:t>=550?4:3}}},builder:{minEnergy:200,makeBody:({available:n,capacity:e})=>{const r=Math.min(n,e);return r>=800?[WORK,WORK,WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE]:r>=550?[WORK,WORK,WORK,CARRY,CARRY,MOVE,MOVE,MOVE]:r>=450?[WORK,WORK,CARRY,CARRY,MOVE,MOVE]:r>=300?[WORK,WORK,CARRY,MOVE]:[WORK,CARRY,MOVE]},memory:n=>({role:n,working:!1,retire:!1}),spawn:{desired:e=>{const o=e.find(FIND_CONSTRUCTION_SITES).filter(e=>n(e)>=250).length,t=!function(n){return n.find(FIND_SOURCES).every(n=>n.pos.findInRange(FIND_STRUCTURES,1,{filter:n=>n.structureType===STRUCTURE_CONTAINER}).length>0)}(e),i=r(e,{containerBelow:.9,roadBelow:.4,minMissingHits:5e3,minTargets:1});return o>10?6:o>5?4:o>0?2:t||i?1:0}}},miner:{minEnergy:300,makeBody:({available:n,capacity:e})=>{const r=Math.min(n,e);return r>=600?[WORK,WORK,WORK,WORK,WORK,MOVE,MOVE]:r>=550?[WORK,WORK,WORK,WORK,WORK,MOVE]:r>=400?[WORK,WORK,WORK,MOVE]:[WORK,WORK,MOVE]},memory:n=>({role:n,working:!1,retire:!1}),spawn:{desired:n=>0,requests:n=>n.find(FIND_SOURCES).filter(n=>!!n.pos.findInRange(FIND_STRUCTURES,1,{filter:n=>n.structureType===STRUCTURE_CONTAINER})[0]).map((n,e)=>({key:n.id,nameHint:"src"+e,memory:{sourceId:n.id}}))}},mover:{minEnergy:250,makeBody:({available:n,capacity:e})=>{const r=Math.min(n,e);return r>=800?[CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE,MOVE,MOVE]:r>=500?[CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE,MOVE]:r>=450?[CARRY,CARRY,CARRY,CARRY,CARRY,MOVE,MOVE,MOVE]:r>=300?[CARRY,CARRY,CARRY,CARRY,MOVE,MOVE]:[CARRY,CARRY,MOVE]},memory:n=>({role:n,working:!1,retire:!1}),spawn:{desired:n=>{var e,r;const o=n.find(FIND_SOURCES).filter(n=>n.pos.findInRange(FIND_STRUCTURES,1,{filter:n=>n.structureType===STRUCTURE_CONTAINER}).length>0);if(0===o.length)return 0;const t=Object.values(Game.creeps).filter(e=>e.room.name===n.name&&"miner"===e.memory.role&&!e.memory.retire&&"string"==typeof e.memory.sourceId),i=new Set(t.map(n=>n.memory.sourceId)),u=o.filter(n=>i.has(n.id)).length;if(0===u)return 0;const c=(null!==(r=null===(e=n.controller)||void 0===e?void 0:e.level)&&void 0!==r?r:1)>=3?2:1;return Math.min(c,u)}}}};function i(n,e){var r,o;const i=t[e],u=null===(o=(r=i.spawn).requests)||void 0===o?void 0:o.call(r,n);return u&&u.length>0?u.length:i.spawn.desired(n)}function u(n){return!n.memory.retire||"near-death"===n.memory.retireReason}function c(n,e){let r=0;for(const o of Object.values(Game.creeps))o.room.name===n.name&&o.memory.role===e&&u(o)&&r++;return r}function R(n){return n.reduce((n,e)=>n+BODYPART_COST[e],0)}function l(n,e){return R(function(n,e){return t[e].makeBody({available:n.energyCapacityAvailable,capacity:n.energyCapacityAvailable,room:n})}(n,e))}function s(n){const e=n.memory.spawnCost;return"number"==typeof e&&Number.isFinite(e)?e:R(n.body.map(n=>n.type))}function a(n,e){const r=t[e],o=i(n,e),u=c(n,e),s=o>0&&u<o,a=s?n.energyAvailable:n.energyCapacityAvailable,f=r.makeBody({available:a,capacity:a,room:n}),E=R(f);return{body:f,cost:E,maxCost:l(n,e),underTarget:s,blockedByEnergy:n.energyAvailable<E}}function f(n){const e={};for(const r of o){if(i(n,r)<=0)continue;if(0===c(n,r))continue;const o=l(n,r);let t=0;for(const e of Object.values(Game.creeps))e.room.name===n.name&&e.memory.role===r&&(e.memory.retire||s(e)<o&&t++);t>0&&(e[r]=t)}return e}function E(n){return!n.memory.retire||"near-death"===n.memory.retireReason}function d(n,e,r){for(const o of Object.values(Game.creeps))if(o.room.name===n.name&&o.memory.role===e&&E(o)&&"miner"===e&&o.memory.sourceId===r)return!0;return!1}function O(n,e,r){var o,i,u;const R=t[e],l=a(n,e),s=null!==(u=null===(i=(o=R.spawn).requests)||void 0===i?void 0:i.call(o,n))&&void 0!==u?u:[];for(const o of s)if(!d(n,e,o.key))return{kind:"request",role:e,key:o.key,nameHint:o.nameHint,memory:o.memory,blockedByEnergy:l.blockedByEnergy,requiredEnergy:l.cost,reason:"missing"===r?"missing":"normal"};const f=R.spawn.desired(n);return c(n,e)<f?{kind:"count",role:e,blockedByEnergy:l.blockedByEnergy,requiredEnergy:l.cost,reason:r}:null}function v(n){var e,r,u;const R={t:Game.time};if(function(n){return c(n,"harvester")+c(n,"miner")+c(n,"mover")===0}(n)){const e=a(n,"harvester");return R.spawn={kind:"count",role:"harvester",blockedByEnergy:e.blockedByEnergy,requiredEnergy:e.cost,reason:"missing"},R}for(const e of o){if(i(n,e)<=0)continue;if(c(n,e)>0)continue;const r=O(n,e,"missing");if(r)return R.spawn=r,R}for(const e of o){const r=O(n,e,"normal");if(r)return R.spawn=r,R}if(function(n){for(const e of o){const r=i(n,e);if(!(r<=0)&&c(n,e)<r)return!1}return!0}(n)){const c=function(n){var e,r;let t=null;for(const u of o){if(i(n,u)<=0)continue;const o=l(n,u);for(const i of Object.values(Game.creeps)){if(i.room.name!==n.name)continue;if(i.memory.role!==u)continue;if(i.memory.retire)continue;const c=s(i);if(c>=o)continue;const R=o-c;(!t||R>t.deficit||t&&R===t.deficit&&(null!==(e=i.ticksToLive)&&void 0!==e?e:999999)<(null!==(r=t.creep.ticksToLive)&&void 0!==r?r:999999))&&(t={role:u,creep:i,cost:c,maxCost:o,deficit:R})}}return t}(n);if(c){const o=l(n,c.role),i=n.energyAvailable<o;if(R.upgrade={role:c.role,retireCreepName:c.creep.name,requiredEnergy:o,blockedByEnergy:i},!i){if((null!==(u=null===(r=(e=t[c.role].spawn).requests)||void 0===r?void 0:r.call(e,n))&&void 0!==u?u:[]).length>0){const n=function(n,e){var r;return"miner"===n&&null!==(r=e.memory.sourceId)&&void 0!==r?r:null}(c.role,c.creep),e=n?function(n,e){return"miner"===n?{sourceId:e}:null}(c.role,n):null;return R.spawn={kind:"count",role:c.role,nameHint:n?n.slice(-4):void 0,memory:null!=e?e:void 0,blockedByEnergy:!1,requiredEnergy:o,reason:"upgrade"},R}return R.spawn={kind:"count",role:c.role,blockedByEnergy:!1,requiredEnergy:o,reason:"upgrade"},R}}}return R}function T(n,e,r,o){const i=t[e],u=a(n.room,e);if(u.blockedByEnergy)return!1;const c={...i.memory?i.memory(e):{role:e},...null!=r?r:{},role:e};c.spawnCost=u.cost;const R=`${e}-${o?o+"-":""}${Game.time%1e3}`,l=n.spawnCreep(u.body,R,{memory:c});return l===OK||(console.log(`spawn failed room=${n.room.name} role=${e} code=${l} cost=${u.cost} energy=${n.room.energyAvailable}/${n.room.energyCapacityAvailable}`),!1)}function C(n){const e=n.memory.o;return e&&e.t===Game.time?e.spawn:v(n).spawn}function m(n,e){n.memory.retire||(console.log(`Creep ${n.name} retiring: ${e}`),n.memory.retire=!0,n.memory.retireReason=e,n.memory.retireMarkedAt=Game.time)}function S(n){return!n.spawning&&"number"==typeof n.ticksToLive}function U(n,e){return Object.values(Game.creeps).filter(r=>r.room.name===n.name&&r.memory.role===e&&!r.memory.retire&&!!S(r))}function _(n,e){const r=n.slice().sort((n,e)=>n.ticksToLive-e.ticksToLive);for(let n=0;n<e&&n<r.length;n++)m(r[n],"excess")}function N(n,e){var r;return"miner"===n&&null!==(r=e.memory.sourceId)&&void 0!==r?r:null}function g(n,e,r){if(!S(r))return!1;if(r.ticksToLive>50)return!1;const o=N(n,r);for(const t of e)if(t.name!==r.name&&S(t)&&(!o||N(n,t)===o)&&t.ticksToLive>50)return!0;return!1}function G(n,e,r){var o;if(r<=0)return;const t=U(n,e);if(!(t.length<r)){if("miner"===e){const n={};for(const r of t){const t=N(e,r);t&&(null!==(o=n[t])&&void 0!==o?o:n[t]=[]).push(r)}for(const r of Object.keys(n)){const o=n[r];if(!(o.length<=1))for(const n of o)g(e,o,n)&&m(n,"near-death")}return}if(!(t.length<=1))for(const n of t)g(e,t,n)&&m(n,"near-death")}}function A(n,e){var r;const o=new Set(function(n,e){var r,o,i;return(null!==(i=null===(o=(r=t[e].spawn).requests)||void 0===o?void 0:o.call(r,n))&&void 0!==i?i:[]).map(n=>n.key)}(n,e));if(0===o.size)return;const i=U(n,e);for(const n of i){const r=N(e,n);r&&o.has(r)||m(n,"request-mismatch")}const u=U(n,e),c={};for(const n of u){const o=N(e,n);o&&(null!==(r=c[o])&&void 0!==r?r:c[o]=[]).push(n)}for(const n of Object.keys(c)){const e=c[n];if(e.length<=1)continue;const r=e.slice().sort((n,e)=>e.ticksToLive-n.ticksToLive),o=r[0];for(const n of r.slice(1))n.name!==o.name&&m(n,"request-duplicate")}const R=U(n,e).length,l=o.size;R>l&&G(n,e,l)}function p(n){const e=(n.memory.o&&n.memory.o.t===Game.time?n.memory.o:v(n)).upgrade;if(!e)return;if(e.blockedByEnergy)return;const r=Game.creeps[e.retireCreepName];r&&r.room.name===n.name&&(r.memory.retire||r.spawning||m(r,"planned-upgrade"))}function y(n){return n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>(n.structureType===STRUCTURE_SPAWN||n.structureType===STRUCTURE_EXTENSION)&&n.store.getFreeCapacity(RESOURCE_ENERGY)>0})||n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>n.structureType===STRUCTURE_STORAGE&&n.store.getFreeCapacity(RESOURCE_ENERGY)>0})}function I(n,e){if("miner"!==n.memory.role&&function(n){const e=new Set;for(const r of Object.values(Game.creeps)){if(r.room.name!==n.name)continue;if("miner"!==r.memory.role)continue;const o=r.memory.sourceId;o&&e.add(o)}return e}(n.room).has(e.id))return"blocked";const r=n.harvest(e);return r===OK?"done":r===ERR_NOT_IN_RANGE?(n.moveTo(e,{reusePath:20}),"not_in_range"):"blocked"}function b(n,e,r,o){var t;const i=r();return i===OK?"done":i===ERR_NOT_IN_RANGE?(n.moveTo(e,null!==(t=null==o?void 0:o.move)&&void 0!==t?t:{reusePath:20}),"not_in_range"):"blocked"}function Y(n,e){const r=n.room.controller;return r?(b(n,r,()=>n.upgradeController(r),{move:void 0}),"upgrade"):"idle"}function h(n,e){const r=n.transfer(e,RESOURCE_ENERGY);return r===OK?"done":r===ERR_NOT_IN_RANGE?(n.moveTo(e,{reusePath:20}),"not_in_range"):"blocked"}function M(n,e,r=!0){n.memory.i!==e&&(n.say(e,r),n.memory.i=e)}const $={harvest:"‚õèÔ∏è",deliver:"üöö",upgrade:"‚ö°",idle:"üò¥"};function K(n,e){if(n.memory.u=e.id,function(n){return n.resourceType===RESOURCE_ENERGY&&"number"==typeof n.amount}(e)){const r=n.pickup(e);return r===OK?"done":r===ERR_NOT_IN_RANGE?(n.moveTo(e,{reusePath:20}),"not_in_range"):"blocked"}if(!function(n){var e,r;return"function"==typeof(null===(e=n.store)||void 0===e?void 0:e.getUsedCapacity)&&"function"==typeof(null===(r=n.store)||void 0===r?void 0:r.getFreeCapacity)}(e))return"blocked";const r=e.store.getUsedCapacity(RESOURCE_ENERGY);if(r<=0)return"blocked";const o=n.store.getFreeCapacity(RESOURCE_ENERGY);if(o<=0)return"done";const t=Math.max(1,function(n,e){let r=0;for(const o of Object.values(Game.creeps))o.room.name===n.name&&0!==o.store.getFreeCapacity(RESOURCE_ENERGY)&&o.memory.u===e&&r++;return r}(n.room,e.id)),i=n.withdraw(e,RESOURCE_ENERGY,Math.max(1,Math.min(o,Math.ceil(r/t))));return i===OK?"done":i===ERR_NOT_IN_RANGE?(n.moveTo(e,{reusePath:20}),"not_in_range"):"blocked"}function W(n){var e,r;const o=n.pos.findClosestByPath(FIND_DROPPED_RESOURCES,{filter:n=>n.resourceType===RESOURCE_ENERGY&&n.amount>=20});if(o)return o;const t=n.room.find(FIND_STRUCTURES,{filter:n=>(n.structureType===STRUCTURE_CONTAINER||n.structureType===STRUCTURE_STORAGE)&&n.store.getUsedCapacity(RESOURCE_ENERGY)>0});return 0===t.length?null:null!==(r=null===(e=t.map(e=>{const r=n.pos.getRangeTo(e),o=function(n,e){let r=0;for(const o of Object.values(Game.creeps))o.room.name===n.name&&0!==o.store.getFreeCapacity()&&o.memory.u===e&&r++;return r}(n.room,e.id),t=e.store.getUsedCapacity(RESOURCE_ENERGY);return{s:e,score:r+5*o-Math.min(10,t/200)}}).sort((n,e)=>n.score-e.score)[0])||void 0===e?void 0:e.s)&&void 0!==r?r:null}function k(n,e){var r,o;const t=null!==(r=e.harvestWithin)&&void 0!==r?r:3,i=null!==(o=e.withdrawWithin)&&void 0!==o?o:12;if(n.getActiveBodyparts(WORK)>0){const r=e.preferPos.findClosestByRange(FIND_SOURCES_ACTIVE,{filter:n=>e.preferPos.getRangeTo(n.pos)<=t});if(r&&"blocked"!==I(n,r))return"harvest"}const u=function(n,e,r){return n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>(n.structureType===STRUCTURE_CONTAINER||n.structureType===STRUCTURE_STORAGE)&&n.store.getUsedCapacity(RESOURCE_ENERGY)>0&&e.getRangeTo(n.pos)<=r})}(n,e.preferPos,i);if(u)return K(n,u),"withdraw";const c=W(n);if(c)return K(n,c),"withdraw";if(n.getActiveBodyparts(WORK)>0){const e=n.pos.findClosestByPath(FIND_SOURCES_ACTIVE);if(e&&"blocked"!==I(n,e))return"harvest"}return"idle"}function w(n,e){var r,o,t;const i=null!==(r=null==e?void 0:e.energyResource)&&void 0!==r?r:RESOURCE_ENERGY;return n.memory.working&&0===n.store.getUsedCapacity(i)&&(n.memory.working=!1,null===(o=null==e?void 0:e.onStopWorking)||void 0===o||o.call(e)),n.memory.working||0!==n.store.getFreeCapacity()||(n.memory.working=!0,null===(t=null==e?void 0:e.onStartWorking)||void 0===t||t.call(e)),n.memory.working?"work":"gather"}const V={withdraw:"üì¶",harvest:"‚õèÔ∏è",upgrade:"‚ö°",idle:"üò¥"},D={withdraw:"üì¶",harvest:"‚õèÔ∏è",build:"üèóÔ∏è",repair:"üõ†Ô∏è",upgrade:"‚ö°",idle:"üò¥"};function P(n){return n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>n.structureType===STRUCTURE_CONTAINER&&n.hits<.9*n.hitsMax})}function F(n){return n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>n.structureType===STRUCTURE_ROAD&&n.hits<.4*n.hitsMax})}function j(n){return function(n){const r=n.room.find(FIND_CONSTRUCTION_SITES);if(0===r.length)return null;const o={preferJoinWithin:20,desiredMaxJoiners:2},t=n.memory.buildTargetId,i=t?Game.getObjectById(t):null;let u=null,c=-1/0;for(const t of r){const r=e(n,t,o);r>c&&(c=r,u=t)}return i&&i.pos.roomName===n.room.name&&e(n,i,o)>=c-150?(n.memory.buildTargetId=i.id,i):(u&&(n.memory.buildTargetId=u.id),u)}(n)}function q(n){var e,r;const o=P(n);if(o)return o.pos;const t=F(n);if(t)return t.pos;const i=j(n);return i?i.pos:null!==(r=null===(e=n.room.controller)||void 0===e?void 0:e.pos)&&void 0!==r?r:n.pos}function B(n,e,r){const o=n.moveTo(e,null!=r?r:{reusePath:20,maxRooms:1});return function(n,e,r){var o,t,i;const u=`${(c=n.pos).x}:${c.y}:${c.roomName}`;var c;if(e.R=e.l===u?(null!==(o=e.R)&&void 0!==o?o:0)+1:0,e.l=u,!((null!==(t=e.R)&&void 0!==t?t:0)<3)&&(n.moveTo(r,{reusePath:0,maxRooms:1}),(null!==(i=e.R)&&void 0!==i?i:0)>=5)){const e=1+Game.time%8;n.move(e)}}(n,n.memory,e),o===ERR_NO_PATH||o===ERR_INVALID_TARGET?"invalid":"moving"}function x(n){return n.resourceType===RESOURCE_ENERGY&&"number"==typeof n.amount}function H(n,e){var r;return!!n&&(null!==(r=n.store.getFreeCapacity(e))&&void 0!==r?r:0)>0}const L={withdraw:"üì¶",deliver:"üöö",idle:"üò¥"},X={harvester:function(n){var e,r;if(n.store.getFreeCapacity(RESOURCE_ENERGY)>0){const r=n.pos.findClosestByPath(FIND_SOURCES_ACTIVE),o=r?"harvest":"idle";return r&&I(n,r),void M(n,null!==(e=$[o])&&void 0!==e?e:$.idle)}const o=y(n),t=o?"deliver":"idle";if(o&&h(n,o),"deliver"===t)return void M(n,$.deliver);const i=Y(n);M(n,null!==(r=$[i])&&void 0!==r?r:$.idle)},upgrader:function(n){var e,r,o;const t="gather"===w(n)?k(n,{preferPos:null!==(r=null===(e=n.room.controller)||void 0===e?void 0:e.pos)&&void 0!==r?r:n.pos}):Y(n);M(n,null!==(o=V[t])&&void 0!==o?o:V.idle)},builder:function(n){var e;const r="gather"===w(n)?k(n,{preferPos:q(n)}):function(n){const e=P(n);if(e)return b(n,e,()=>n.repair(e),{move:{reusePath:25}}),"repair";const r=F(n);if(r)return b(n,r,()=>n.repair(r),{move:{reusePath:25}}),"repair";const o=j(n);return o?(b(n,o,()=>n.build(o),{move:{reusePath:25}}),"build"):Y(n)}(n);M(n,null!==(e=D[r])&&void 0!==e?e:D.idle)},miner:function(n){const e=n.memory.sourceId;if(!e)return void M(n,"‚ùì");const r=Game.getObjectById(e);if(!r)return M(n,"üíÄ"),void m(n,"bad-source");const o=function(n,e){var r;const o=n.pos.findInRange(FIND_STRUCTURES,1,{filter:n=>n.structureType===STRUCTURE_CONTAINER});if(0===o.length)return null;if(!e)return o[0];const t=o.find(n=>e.pos.isEqualTo(n.pos));if(t&&t.store.getFreeCapacity(RESOURCE_ENERGY)>0)return t;const i=o.filter(n=>n.store.getFreeCapacity(RESOURCE_ENERGY)>0).filter(n=>n.id!==(null==t?void 0:t.id)).sort((n,r)=>e.pos.getRangeTo(n)-e.pos.getRangeTo(r))[0];return null!==(r=null!=i?i:t)&&void 0!==r?r:o[0]}(r,n);o?"done"===function(n,e){if(n.pos.isEqualTo(e))return"done";const r=n.moveTo(e,{reusePath:20});return r===OK||r===ERR_TIRED?"not_in_range":"blocked"}(n,o.pos)?(M(n,"‚õèÔ∏è"),I(n,r)):M(n,"‚û°Ô∏è"):M(n,"‚õî")},mover:function(n){var e;const r="gather"===w(n,{onStartWorking:()=>{delete n.memory.u},onStopWorking:()=>{delete n.memory.O}})?"acquire"===function(n,e){var r;const o=n.memory;let t=(i=e.cache.getId(o))?Game.getObjectById(i):null;var i;if(!t||!function(n){return x(n)?n.amount>0:n.store.getUsedCapacity(RESOURCE_ENERGY)>0}(t)){if(e.cache.clearId(o),t=e.findTarget(n),!t)return"idle";e.cache.setId(o,t.id)}const u=x(t)?n.pickup(t):n.withdraw(t,RESOURCE_ENERGY);return u===OK?"acquire":u===ERR_NOT_IN_RANGE?("invalid"===B(n,t.pos,null!==(r=e.move)&&void 0!==r?r:{reusePath:20,maxRooms:1})&&e.cache.clearId(o),"acquire"):(e.cache.clearId(o),"idle")}(n,{cache:{getId:n=>n.u,setId:(n,e)=>{n.u=e},clearId:n=>{delete n.u}},findTarget:W,move:{reusePath:20,maxRooms:1}})?"withdraw":"idle":function(n,e){var r,o;const t=null!==(r=e.resource)&&void 0!==r?r:RESOURCE_ENERGY,i=n.memory;let u=(c=e.cache.getId(i))?Game.getObjectById(c):null;var c;if(!H(u,t)){if(e.cache.clearId(i),u=e.findTarget(n),!H(u,t))return"idle";e.cache.setId(i,u.id)}const R=n.transfer(u,t);return R===OK?"deliver":R===ERR_NOT_IN_RANGE?("invalid"===B(n,u.pos,null!==(o=e.move)&&void 0!==o?o:{reusePath:20,maxRooms:1})&&e.cache.clearId(i),"deliver"):(e.cache.clearId(i),"idle")}(n,{cache:{getId:n=>n.O,setId:(n,e)=>{n.O=e},clearId:n=>{delete n.O}},findTarget:y,move:{reusePath:20,maxRooms:1},resource:RESOURCE_ENERGY});M(n,null!==(e=L[r])&&void 0!==e?e:L.idle)}};function J(n){var e;return null!==(e=Object.values(Game.spawns).find(e=>e.room.name===n.name))&&void 0!==e?e:null}function z(n){var e,r;if(!n.memory.retire)return!1;if(M(n,`Retiring... (${n.memory.retireReason})`),n.store.getUsedCapacity(RESOURCE_ENERGY)>0){const e=function(n){return n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>(n.structureType===STRUCTURE_SPAWN||n.structureType===STRUCTURE_EXTENSION)&&n.store.getFreeCapacity(RESOURCE_ENERGY)>0})}(n);if(e)return h(n,e),!0;const r=function(n){return n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>(n.structureType===STRUCTURE_SPAWN||n.structureType===STRUCTURE_EXTENSION)&&n.store.getFreeCapacity(RESOURCE_ENERGY)>0})||n.pos.findClosestByPath(FIND_STRUCTURES,{filter:n=>n.structureType===STRUCTURE_STORAGE&&n.store.getFreeCapacity(RESOURCE_ENERGY)>0})}(n);return r?(h(n,r),!0):(n.drop(RESOURCE_ENERGY),!0)}const o=J(n.room);if(o){if(n.pos.isNearTo(o))return M(n,"‚ôªÔ∏è"),o.recycleCreep(n),!0;if((null!==(e=n.ticksToLive)&&void 0!==e?e:0)>o.pos.getRangeTo(n.pos)+10)return n.moveTo(o,{reusePath:50}),!0}const t=null!==(r=function(n){var e;const r=Game.flags.Graveyard;if(!r)return null;const o=0===r.pos.getRangeTo(n.pos)?[r.pos]:n.room.lookForAtArea(LOOK_TERRAIN,Math.max(0,r.pos.y-1),Math.max(0,r.pos.x-1),Math.min(49,r.pos.y+1),Math.min(49,r.pos.x+1),!0).filter(n=>"wall"!==n.terrain).map(n=>new RoomPosition(n.x,n.y,r.pos.roomName));return null!==(e=n.pos.findClosestByRange(o))&&void 0!==e?e:r.pos}(n))&&void 0!==r?r:function(n){var e;const r=null!==(e=J(n.room))&&void 0!==e?e:Object.values(Game.spawns)[0];return r?new RoomPosition(r.pos.x+1,r.pos.y+1,r.pos.roomName):null}(n);return!t||(n.pos.isEqualTo(t)?(M(n,"üíÄ"),!0):(n.moveTo(t,{reusePath:50}),!0))}function Q(n){const e=n.memory;return e&&e.role?("string"!=typeof(r=e.role)||!(r in t))&&(m(n,"invalid"),z(n)):(m(n,"invalid"),z(n));var r}const Z="  ";function nn(n){const e=n.memory.o;return e&&e.t===Game.time?e:v(n)}function en(n){const e=n.controller;return e?{level:e.level,progress:e.progress,progressTotal:e.progressTotal,pct:e.progressTotal>0?e.progress/e.progressTotal*100:0}:{level:null,progress:null,progressTotal:null,pct:null}}function rn(n){var e;const r=function(n){var e,r;const o={};for(const t of Object.values(Game.creeps)){if(t.room.name!==n.name)continue;const i=null!==(e=t.memory.role)&&void 0!==e?e:"unknown";o[i]=(null!==(r=o[i])&&void 0!==r?r:0)+1}return o}(n),o={};for(const u of Object.keys(t))o[u]={current:null!==(e=r[u])&&void 0!==e?e:0,target:i(n,u)};return o}function on(n){const e=nn(n),r=e.spawn,o=e.upgrade;return{spawn:r?"request"===r.kind?{kind:"request",role:r.role,keySuffix:r.key.slice(-4),requiredEnergy:r.requiredEnergy,blockedByEnergy:r.blockedByEnergy}:{kind:"role",role:r.role,requiredEnergy:r.requiredEnergy,blockedByEnergy:r.blockedByEnergy,reason:r.reason}:null,upgrade:o?{retireCreepName:o.retireCreepName,requiredEnergy:o.requiredEnergy,blockedByEnergy:o.blockedByEnergy}:null}}function tn(n){const e=Object.values(Game.spawns).filter(e=>e.my&&e.room.name===n.name).sort((n,e)=>n.name.localeCompare(e.name)),r=nn(n),o=r.spawn&&("request"===r.spawn.kind?`${r.spawn.role}[${r.spawn.key.slice(-4)}] ${r.spawn.requiredEnergy}e${r.spawn.blockedByEnergy?" ‚õî":""}`:`${r.spawn.role} ${r.spawn.requiredEnergy}e${r.spawn.blockedByEnergy?" ‚õî":""}${"upgrade"===r.spawn.reason?" (upgrade)":""}`);return e.map(n=>n.spawning?{name:n.name,state:"spawning",spawning:{name:n.spawning.name,remainingTime:n.spawning.remainingTime},next:null}:{name:n.name,state:"idle",next:null!=o?o:null})}function un(n){return{candidates:f(n)}}function cn(n){const e=[];for(const r of o){const o=n[r];o&&e.push([r,o])}for(const[r,t]of Object.entries(n))o.includes(r)||e.push([r,t]);return e}function Rn(n){var e;const r=n.spawn,o=n.upgrade;return`plan: ${r?"request"===r.kind?`spawn=${r.role}[${r.keySuffix}]${r.blockedByEnergy?" ‚õî":""}`:`spawn=${r.role}${"upgrade"===r.reason?"(upgrade)":""}${r.blockedByEnergy?" ‚õî":""}`:"spawn=none"} ${o?`upgrade=${o.retireCreepName} (energy required: ${null!==(e=o.requiredEnergy)&&void 0!==e?e:"?"})${o.blockedByEnergy?" ‚õî":""}`:"upgrade=none"}`}function ln(n){var e;const r=Object.entries(null!==(e=n.candidates)&&void 0!==e?e:{});return 0===r.length?"upgrades: none":"upgrades: "+r.map(([n,e])=>`${n}:${e}`).join(", ")}function sn(n){return n&&0!==n.length?"spawns: "+n.map(n=>"spawning"===n.state&&n.spawning?`${n.name}:spawning ${n.spawning.name} (${n.spawning.remainingTime}t)`:n.next?`${n.name}:idle (next: ${n.next})`:n.name+":idle").join(" | "):"spawns: none"}function an(n){const{room:e}=n;return n.pos.findInRange(FIND_SOURCES,2).length>0?"source":e.controller&&n.pos.inRangeTo(e.controller,3)?"controller":e.storage&&n.pos.inRangeTo(e.storage,2)?"storage":"hub"}function fn(n){const e=n.find(FIND_MY_STRUCTURES,{filter:n=>n.structureType===STRUCTURE_LINK}),r={source:[],hub:[],controller:[],storage:[]};for(const n of e){const e=an(n);e&&r[e].push(n)}return r}exports.loop=()=>{!function(){for(const n in Memory.creeps)n in Game.creeps||delete Memory.creeps[n]}(),function(){var n;for(const e of Object.values(Game.rooms))(null===(n=e.controller)||void 0===n?void 0:n.my)&&(e.memory.o=v(e))}(),function(){var n,e,r;const u=Object.values(Game.rooms).filter(n=>{var e;return null===(e=n.controller)||void 0===e?void 0:e.my});if(0!==u.length)for(const c of u){for(const u of o){if((null!==(r=null===(e=(n=t[u].spawn).requests)||void 0===e?void 0:e.call(n,c))&&void 0!==r?r:[]).length>0){A(c,u);continue}const o=i(c,u),R=U(c,u),l=R.length;l>o?_(R,l-o):G(c,u,o)}p(c)}}(),function(){var n;const e=Object.values(Game.spawns);if(0!==e.length)for(const r of e){if(!r.my)continue;if(r.spawning)continue;const e=C(r.room);e&&(e.blockedByEnergy||("request"!==e.kind?T(r,e.role):T(r,e.role,e.memory,null!==(n=e.nameHint)&&void 0!==n?n:e.key.slice(-4))))}}(),function(){const n=Object.values(Game.rooms).filter(n=>{var e;return null===(e=n.controller)||void 0===e?void 0:e.my}).sort((n,e)=>n.name.localeCompare(e.name)),e={t:Game.time,cpu:{used:Game.cpu.getUsed(),limit:Game.cpu.limit,bucket:Game.cpu.bucket},rooms:n.map(n=>({name:n.name,energy:{available:n.energyAvailable,capacity:n.energyCapacityAvailable},rcl:en(n),spawns:tn(n),roles:rn(n),plan:on(n),upgrades:un(n)}))};Memory.stats=e}(),function(n=50){if(Game.time%n!==0)return;const e=Memory.stats;if(e){if(console.log("-------------------------------"),console.log(`[STATS t=${e.t}] - CPU:${e.cpu.used.toFixed(2)}/${e.cpu.limit} bucket:${e.cpu.bucket}`),!e.rooms||0===e.rooms.length)return console.log("rooms: none"),void console.log("-------------------------------");for(const n of e.rooms){const e=null==n.rcl.pct?"?":n.rcl.pct.toFixed(1);console.log(`room ${n.name}: energy=${n.energy.available}/${n.energy.capacity} rcl=${null==n.rcl.level?"?":n.rcl.level}(${e}%)`),console.log(`${Z}${sn(n.spawns)}`);const r=cn(n.roles).map(([n,e])=>`${n}:${e.current}/${e.target}`).join(", ");console.log(`${Z}roles: ${r}`),console.log(`${Z}${Rn(n.plan)}`),console.log(`${Z}${ln(n.upgrades)}`)}console.log("-------------------------------")}}(25),function(){var n;for(const e of Object.values(Game.rooms)){if(!(null===(n=e.controller)||void 0===n?void 0:n.my))continue;const{source:r,hub:o,controller:t,storage:i}=fn(e),u=[...t,...i].filter(n=>n.store.getFreeCapacity(RESOURCE_ENERGY)>0);if(0===u.length)return;const c=[...r,...o].filter(n=>n.store.getUsedCapacity(RESOURCE_ENERGY)>=200);for(const n of c){if(n.cooldown>0)continue;const e=u[0];if(!e)break;n.transferEnergy(e)}}}();for(const n in Game.creeps){const e=Game.creeps[n];if(Q(e))continue;if(z(e))continue;const r=e.memory.role,o=r?X[r]:void 0;o&&o(e)}};//# sourceMappingURL=main.js.map
